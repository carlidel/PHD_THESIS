
\chapter{Hamiltonian dynamics}\label{ch:mathematical_elements}

In this chapter, we present a brief review of the fundamental concepts of Hamiltonian dynamics, which will be used throughout this thesis. We start by recalling the basic concepts of Hamiltonian dynamics and coordinate transformations. We then focus on the fundamental concepts of perturbation theory, such as the averaging principle.

Next, we present the KAM and Nekhoroshev theorems, two fundamental results of perturbation theory, which constitute the foundation of this thesis. These two theorems give important insights on the behaviour of an otherwise integrable Hamiltonian system under small perturbations, which is exactly the case of the study of the dynamics of a particle in the magnetic field of a circular accelerator.

Finally, we introduce the concept of symplectic map, which is a mathematical object which found multiple applications in the field of accelerator physics as a ``one-turn map'', and see how these two theorems can be applied to the study of symplectic maps.

\section{Generalities}\label{sec:1:hamiltonian}

We start by recalling some of the fundamental concepts of Hamiltonian dynamics. This will also define the core elements of nomenclature and notation that will be used throughout this thesis. This theoretical recall mainly follows Ref.~\cite{Arnold:937549}.

Let $(\vb{q}(t),\vb{p}(t))$ be a set of coordinates in a 2$n$ dimensional phase space, and let $\ham(\vb{q},\vb{p},\, t)$ be a differentiable real function, a dynamical system is said to be \textit{Hamiltonian} if the following equations hold:
%
\begin{equation} 
	%\begin{split}
	\dot q_i = \pdv{\ham}{p_i}
		\,,\qquad 		\dot p_i = -\pdv{\ham}{q_i} \, i=1,..,n.
%	\end{split}
	\label{hameq}
 \end{equation} 

These equations are called \textit{Hamilton} or \textit{canonical} equations with $\ham$ being the \textit{Hamiltonian} of the system under study. They are related to a geometrical Least Action Principle via the differential 1-form in the extended $2n+1$-dimensional phase space 
%
\begin{equation} \omega = p_i \dd q_i -\ham \dd t \, .  
\end{equation}

In fact, if one considers the differential of the 1-form
\begin{equation}
    \dd\omega= \dd p_i\wedge \dd q_i-\pdv{\ham}{q_i}\dd q_i \wedge \dd t-\pdv{\ham}{p_i} \dd p_i \wedge \dd t
    \label{dome}
\end{equation}
one defines the vortex lines as the curves in the extended phase space whose tangent is parallel to the null eigenvector of the 2-form $\dd\omega$. Then it is possible to prove that the vortex lines $1$-form have one-to-one projection on the time axis that correspond to the orbits $\vb{q}(t)\, , \, \vb{p}(t)$ which solve the Hamilton equations, 

\begin{comment}
is described by the motion of a particle in the time interval $[t_0,\,t_1]$ yields
\begin{equation}
    \int_{q_0=q(t_0)}^{q_1=q(t_1)} \qty(p_i \dd q_i - \ham \dd t) = \int_{t_0}^{t_1} \qty(p_i \dv{q_i}{t} - \ham)\dd t =  \int_{t_0}^{t_1} \mathcal{L} \dd t\,, 
\end{equation}
where $\mathcal{L}=p_i\dot q_i - \ham$ is the Lagrangian, obtained by the Legendre transformation of the Hamiltonian. 
\end{comment}
\subsection{Canonical transformations}

The main advantage of having a Hamiltonian formulation of a system is the greater freedom in coordinates choice in the phase space than the corresponding Lagrangian systems. Differently from a Lagrangian formulation, positions and momenta are independent and can be exchanged both in role or mixed to archive optimal formulations, all while the Hamiltonian equation maintains its form. Such changes in coordinates have, however, to maintain the canonical of the Hamiltonian equation defined in Eq.~\eqref{eq:hamem}, also referred to as \textit{symplectic conditions}.

Let us consider a Hamiltonian $\ham(\vb{p},\vb{q},t)$, for which we wish to apply a coordinate transformation $(p_i,q_i)\to(P_i,Q_i)$. To maintain the Hamiltonian properties, we then look for a new Hamiltonian $\mathcal{K}(\vb{P},\vb{Q},t)$ for which
%
\begin{equation}
    \dot P_i = -\pdv{\mathcal{K}}{Q_i}\,, \qquad \dot Q_i = \pdv{\mathcal{K}}{P_i}\,.
\end{equation}
%
Both Hamiltonian formulations need to leave invariant the structure of the differential form (\ref{dome}) to maintain the canonical form of the equation of motion:
%
\begin{equation}
    \dd (p_i \dd q_i- \ham \dd t) = \dd(P_i \dd Q_i - \mathcal{K}\dd t)\,,
\end{equation}
%
which implies that the differential
%
\begin{equation}.
    \dd F = p_i\dd q_i - P_i \dd Q_i + (\mathcal{K}-\ham)\dd t\, ,
\end{equation}
%
must be exact. This provides the Hamiltonian transformation laws
%
\begin{equation} 
	p_i = \pdv{F}{q_i}\,, \qquad P_i = -\pdv{F}{Q_i}\,, \qquad \mathcal{K}=\ham+\pdv{F}{t}\,.
\end{equation}
%
Note that the Hamiltonian function changes if the transformations are time-dependent. The function $F(\vb{q},\vb{Q},t)$ is called the \textit{generating function} of the coordinate transformation.

In the Hamiltonian formulation, the full freedom in coordinate choice is such that even the role of time can be reassigned to another coordinate. We will see in the next chapter how this freedom enables the Courant-Snyder coordinate system, used in accelerator physics.

When a coordinate is used to parameterize the orbit, we have that the momentum conjugate to that coordinate, with a minus sign, becomes the new Hamiltonian function.

As an example, let us assign the role of time to the $k$th space coordinate $q_k$. Let us indicate the $k$th pair of coordinates as $p_k = \tilde p$, $q_k=\tilde q$. From this we can choose the formally equivalent form
%
\begin{equation}
    p_i \dd q_i - \ham \dd t = \sum_{i\neq k} p_i \dd q_i + (-\ham)\dd t + (-\tilde p)\dd\tilde q\,,
\end{equation}
%
which highlights the new coordinate roles, as now it is possible to express the motion as a function of $\tilde q$, whilst $-\tilde p$ plays the role of the Hamiltonian. In this new form, the equivalent equations of motion become
%
\begin{equation} 
\begin{split}
	&\dv{p_i}{\tilde q} = -\pdv{\tilde p}{q_i}\,, \qquad \dv{q_i}{\tilde q} = \pdv{\tilde p}{p_i} \qquad (i\neq k)\,, \\
	&\dv{\ham}{\tilde q} = -\pdv{\tilde p}{t}\,,  \qquad \dv{t}{\tilde q} = \pdv{\tilde p}{\ham}\,. 
\end{split}
\end{equation}

Finally, the phase flow of a Hamiltonian system is itself a group of canonical transformations as a consequence of the geometrical nature of the variational principle associated to the canonical equations. This property justifies the construction of \textit{symplectic integrators}, i.e.\ algorithms for the numerical integration of Hamilton equations that preserve the Hamiltonian structure of the system.


\subsection{Action-angle variables}

We consider a $n$ degree-of-freedom integrable Hamiltonian system, which will have a $2n$ dimensional phase-space with a symplectic manifold described by the phase variables $(q_.i,\,p_i)$, where $n$ integrals of motion $J_i$ in involution are known (i.e. if one considers $J_i$ as Hamiltonian functions, the corresponding phase flows that solves the canonical equations, commute).

The Liouville theorem states that, if the surfaces $M_{k}$ defined by $J_i=k_i$ are compact, then they are diffeomorphic to $n$ tori $\mathbb{T}^n$, and it is possible to perform a canonical change of variables to the action-angle coordinates $(\phi_i,I_i)$ such that the action $I_i(\vb{J})$ are first integrals of motion and the angles $\phi_i$ evolve according to
\begin{equation}
    \dot{\phi}_i = \omega_i(I_1\,\dots,\,I_n)\,, 
\end{equation}
where $\omega_i$ define the \textit{frequencies} of the motion.

This implies that if we set as Hamiltonian one of the integrals of the motion, for example, $\ham=J_1(\vb{I}$, we see that the new equations of motion read
\begin{equation} 
    \dot I_i = 0\,, \qquad \dot \phi_i = \omega_i(I_1\,\dots,\,I_n) \,,
\end{equation} 


The actions $I_i$ can be explicitly computed. Let us start with the one-di\-men\-sio\-nal case, where the only integral of motion is the Hamiltonian $\ham$ itself, and its conserved value $h$ is the energy, and the set $M_k$ reduces to $M_h$.

We can then define a canonical transformation starting from the generating function $S(\vb{I},\vb{q})$, which yields
%
\begin{equation}
  \vb{p}=\pdv{S}{\vb{q}}\,, \qquad \boldsymbol{\phi}=\pdv{S}{\vb{I}}\,, \qquad \ham\qty(\vb{p}=\pdv{S}{\vb{q}},\vb{q}) = h(\vb{I})\,.
  \label{eq:transf1}
  \end{equation} 
%
The invariant torus are the level closed curves identified by the value of the Hamiltonian $\ham=h$ that depends on the action $\ham=\ham(I)$. On the energy level curves, the differential of the generating function $\dd S$ reduces
%
\begin{equation} 
    \dd S = \pdv{S}{q}\,\dd q = p\,\dd q\,,
\end{equation} 
%
which implies
%
\begin{equation}
    S(q,I) = \int_{M_h}^q p\, \dd q\,,
    \label{eq:S}
\end{equation} 
%

The $1-$form $p\,\dd q$ is closed and therefore locally exact on invariant surfaces $M_h$. But if one performs a cycle a level curve $M_h$, the $S$ value changes according to
%
\begin{equation}
    \Delta S(I) = \oint\displaylimits_{M_{h(I)}} \vb{p}\, \dd \vb{q} \,.
\end{equation} 
%
Due to Stokes' theorem, this last integral corresponds to the area inside the curve.  To define an angular variable $\phi$ by the second equation of \eqref{eq:transf1}, we require that
%
\begin{equation} 
    \oint\displaylimits_{M_{h(\vb{J})}} \dd\boldsymbol{\phi} = 2\pi\,,  
\end{equation} 
%
Then the periodicity of $\phi$ on the torus implies
%
\begin{equation} 
    \oint\displaylimits_{M_{h(I)}} \dd\qty(\pdv{S}{I}) = \pdv{\Delta S(I)}{I} = 2\pi\,, 
\end{equation}
%
from which we finally get the expression for the canonical action variable $I$
%
\begin{equation}  
    I = \frac{1}{2\pi}\oint\displaylimits_{M_h} p\,\dd q\,.  
\end{equation} 
%
On the other hand, differentiating \eqref{eq:S} in $\vb{I}$ we obtain the following, from the definition of $\phi$
%
\begin{equation} 
    \phi = \frac{1}{2\pi} \pdv{I}\int p\,\dd q\, . 
\end{equation}  

Generalization to systems with many of degrees of freedom requires to prove that the differential form $\vb{p}\dd \vb{q}$ is closed on the invariant surfaces and the construction $n$ basic cycles $\gamma_1,\dots, \gamma_n$ 1\textsc{d} on the tori $M_{k_i}$. Then one requires that the variation of the angular variable $\phi_i$ integrated along the cycle $\gamma_j$ is equal to $2\pi\delta_{ij}$, where $\delta_{ij}$ is the Kronecker symbol.

In such a scenario, the actions variables $\vb{I}_i$ then read as
%
\begin{equation}
    \vb{I}_i(k_1,\dots,k_n) = \frac{1}{2\pi}\int_{\gamma_i} \vb{p}_j\, \dd \vb{q}_j\, .  
\end{equation} 
%
It can be shown that these integrals are independent of the choice of $\gamma_i$.~\cite{Arnold:937549}

\section{Perturbation theory for Hamiltonian systems}\label{sec:1:averaging}

Many physical systems can be modelled and described in terms of an ideal integrable Hamiltonian affected by small non-integrable perturbations. A common example is the problem of the motion of planets around the Sun, which can be treated as a perturbation of an ideal motion of non-interacting planets around a fixed attracting centre. Another relevant example, as we shall see in the next chapter, is how the motion of a charged particle inside a circular accelerator can be described as the perturbation of an otherwise ideal harmonic oscillator-like betatron motion around a reference orbit.

Understanding how these perturbations affect the properties of a Hamiltonian system is one of the main problems in dynamical systems, which was called by Poincaré \textit{``fundamental problem of dynamics''}. Multiple approaches to this problem have been explored and grouped under the general topic of \textit{perturbation theory}.

If the evolution timescale of the perturbation is much smaller than the timescale of the unperturbed system, a standard approach that is often proposed in perturbation theory is to \textit{average} over time the perturbations, under the idea that dynamics can be separated into a slow-fast variables evolution. This method is called \textit{averaging principle}. We highlight this specific choice of words, as, Arnold reminds us, it is ``not a theorem, but a physical proposition, that is, a vaguely stated and, strictly speaking, false assertion''. However, ``Such assertions often happen to be fruitful sources for mathematical theorems''~\cite{Arnold:937549}.

Let us consider an integrable Hamiltonian system $\ham_0$ with $n$ degrees of freedom. This defines a foliation of a domain of its phase space into invariant tori, which defines the action-angle variables $\vb{I}=(I_1, \ldots, I_n)$, $\boldsymbol{\phi}=(\phi_1, \ldots, \phi_n)$. 

The Hamiltonian $\ham_0$ depends only on the action variables $\ham_0=\ham_0(\vb{I})$. The equations of motion in the unperturbed case have the standard form:
\begin{equation}
    \dot{\vb{I}}=0\,, \qquad \dot{\boldsymbol{\phi}} = \pdv{\ham_0}{\vb{I}} = \boldsymbol{\omega}(I_1,\dots,I_n) \,,
\end{equation}
where $\boldsymbol{\omega}$ are the frequencies of motion.
Let us now add a small Hamiltonian perturbation to $\ham_0$, i.e.\ we consider $\ham_1(\vb{I}, \boldsymbol{\phi}, \epsilon)$ of period $2\pi$, with $\epsilon$ being a small parameter that represents the magnitude of the perturbation. The resulting perturbed Hamiltonian reads:
\begin{equation}
    \ham = \ham_0 + \epsilon \ham_1\,.
\end{equation}
%
If $\ham_0$ is integrable, we can write the equations of motion in terms of the action angle variables $(I_j,\phi_j)$:
%
\begin{equation}
    \dot I_j = -\epsilon \pdv{\ham_1}{\phi_j}\,,\qquad
	\dot \phi_j = \omega_j + \epsilon \pdv{\ham_1}{I_j}\, .
\end{equation}
%

The same notation can be used if the perturbation is also periodic in time with frequency $\omega_p$, as one can extend the phase space to introduce one new degree of freedom: the angle $\psi=\omega_p t$ and the conjugated momentum $I_\psi$.

If we apply the concept of averaging principle to the perturbed Hamiltonian system, considering the angle fast variables and the action slow variables,
we transform the perturbed system into a simpler one, where the fast periodic oscillations are averaged out. These oscillations are eventually treated as an extra drift element in the original unperturbed solution. We then define a new averaged Hamiltonian $\av{\ham}$ which reads
%
\begin{equation} 
	\av\ham(\vb{I}) = \ham_0(\vb{I})+\epsilon \av{ \ham_1(\vb{I}, \boldsymbol{\phi} }\,,
\end{equation}
%
where we are considering the standard definition of integral average
%
\begin{equation} 
	\av{f} = \frac{1}{(2\pi)^n}\oint_{\mathbb{T}^n}\dd^n\boldsymbol{\phi}\, f(\vb{I}, \boldsymbol{\phi}) \, .
\end{equation}
%
%where $\mathbb{T}^n$ is the $n$-dimensional torus.

To be able to correctly apply the averaging principle, it is fundamental that all the Fourier components of the perturbation have a fast variation. This condition requires that the frequencies $\omega_j$ are not under any resonant conditions. That is, there must be no vector of frequencies $\omega_{1,\ldots,r}\,(r\leq n)$ such that there exists a vector $k_j \in \mathbb{Z}^r$ for which $\sum k_j \omega_j \approx 0$.

When a non-resonant condition holds, it is possible to prove that the action variables $I_j$, can change by a quantity $\mathcal{O}(\epsilon)$ after a time interval $\mathcal{O}(\epsilon)$,  
When a resonant condition is satisfied, it is not possible to perform this kind of averaging since we have a slow dynamics also in the angular dependence, that may introduce significant effects of the perturbation on the action dynamics. This can be seen in a simple example $r=2$, i.e.\ where, in an $n-$dimensional system, which has an $n-$size vector of frequencies $\boldsymbol{\omega}$, we consider $\omega_1$ and $\omega_2$ to be in resonant condition with integer numbers $k_1$ and $k_2$. If we consider the following linear symplectic transformation
\begin{equation}
    \theta_1 = k_1 \phi_1 + k_2 \phi_2\,,\qquad \theta_j=\phi_j,\, \text{for}\ 3\leq j \leq n\,,
\end{equation}
which also implies the linear transformation of the momenta $I_j$ into $\tilde I_j$ due to the symplectic conditions. We obtain the result that the new equation of motion for $\theta_1$ is
\begin{equation}
    \dot\theta_1 = k_1\omega_1 + k_2\omega_2 + \epsilon \pdv{\ham_1}{\tilde I_1} \approx \epsilon \pdv{\ham_1}{\tilde I_1} = \mathcal{O}(\epsilon)\,.
\end{equation}
As $\theta_1$ evolves as a slow variable, it does not meet the conditions to be averaged. All the other $n - 2$ angles $\theta_j$, however, do, as they exhibit an evolution $\mathcal{O}(1)$. This canonical transformation can be extended, and the resulting system will be a system with $r$ slow evolving angles and $n - r$ fast angles.  


% qui a quale teorema ti riferisci? Dal momento che la tua tesi utilizza un approccio diffusivo alla dinamica Hamiltoniana io vedrei bene una parte che sul caos e indicatori correlati in modo da inserire l'approccio stocastico, In questo senso i teoremi delle media sarebbero sulle variabili stocastiche angolari non nel caso deterministico

\section{Kolmogorov-Arnold-Moser (KAM) theory}\label{sec:1:kam}
% Questa parte dovrebbe essere breve e precisa (ovvero i teoremi vanno citati in modo rigoroso). La focalizzerei sulle mappe per le applicazioni agli acceleratori e sulla nascita delle aree debolmente caotiche. La facciamo a quattro mani (ovvero imposta il file tex e poi intervengo io)

As stated in the previous section, the averaging principle is not a mathematically proven theorem that can be applied to every physical system. However, for the case of Hamiltonian systems, there are rigorous results that offer better insight into the effects of perturbations. One of the most important results is the theorem of Kolmogorov~\cite{KAM1} for \textit{non-degenerate} Hamiltonian systems, then extended by Arnold~\cite{KAM3} for \textit{isoenergetically non-degenerate} ones, which proves the existence of invariant tori for a perturbed Hamiltonian system.

Let us consider a perturbed Hamiltonian system in the form of
\begin{equation}
    \ham(\vb{I}, \boldsymbol{\phi}, \epsilon) = \ham_0(\vb{I}) + \epsilon\ham_1(\vb{I},\boldsymbol{\phi},\epsilon)\,.
    \label{eq:1:hamperturbed}
\end{equation}
When considering the unperturbed Hamiltonian $\ham_0$, we have that its phase space is foliated into invariant tori $\vb{I}=const$. The tori with non-resonant frequencies have trajectories that fill them everywhere densely. On the contrary, the tori with resonant frequencies will be foliated into invariant tori of lower dimension.

The unperturbed system $\ham_0$ is classified as \textit{non-degenerate} if its frequencies are functionally independent, namely, if
\begin{equation}
    \det\left(\pdv{\omega}{\vb{I}}\right) = \det\left(\pdv[2]{\ham_0}{\vb{I}}\right) \neq 0 \,.
\end{equation}
In such a nondegenerate system, the non-resonant tori form a set in the phase space of full measure. The resonant tori, instead, form a set of measure zero, which, however, is still dense in the phase space. Most importantly, we have the following application.
\begin{equation}
    \begin{array}{r}
    F: \mathbb{R}^{n} \longrightarrow \mathbb{R}^n \\
    (\vb{I}) \longrightarrow(\boldsymbol{\omega})
    \end{array}
\end{equation}
is a diffeomorphism. This means that the invariant tori are equally well described by the action variables $I$ or by their corresponding frequencies $\omega$.

The unperturbed system $\ham_0$ is classified as \textit{isoenergetically non-degenerate} if the following condition holds:
\begingroup
\renewcommand*{\arraystretch}{1.5}
\begin{equation}
    \operatorname{det}\begin{pmatrix}
    \frac{\partial \boldsymbol{\omega}}{\partial \vb{I}} & \omega_n \\
    \omega_n & 0
    \end{pmatrix}=\operatorname{det}\begin{pmatrix}
    \frac{\partial^2 \ham_0}{\partial \vb{I}^2} & \frac{\partial \ham_0}{\partial I_n} \\
    \frac{\partial \ham_0}{\partial I_n} & 0
    \end{pmatrix} \neq 0 \,,
\end{equation}
\endgroup
i.e., one of the frequencies does not vanish and the ratio of the other frequencies $n-1$ to it is functionally independent of the value of $\ham_0$. Likewise to the non-degenerate condition, also this condition guarantees the existence on every energy level surface of a set of densely populated invariant tori, which will have full measure for non-resonant frequencies and zero measure for resonant frequencies. The non-degenerate and the isoenergetically non-degenerate conditions are independent.

Now that we have recalled these definitions, we can state the KAM theorem, which proves the existence of a large measure set of invariant tori for the perturbed $\ham$ in the phase space:
\begin{theorem}[KAM~\cite{KAM1, KAM2, KAM3}]\label{th:kam}
If the unperturbed Hamiltonian system $\ham_0$ is non-degenerate or isoenergetically non-degenerate, then, in the perturbed Hamiltonian system such as Eq.~\eqref{eq:1:hamperturbed}, most of the non-resonant invariant tori do not disappear but are only slightly deformed. More specifically, there exist positive constants $\epsilon_0,\ a_1,\ a_2,$ and $a_3$, independent of $\epsilon$, such that for any $\epsilon < \epsilon_0$ one can find:
\begin{enumerate}
    \item [(a).] a near to identity canonical transformation
    \begin{equation}
        \begin{array}{r}
        \mathcal{C}_\epsilon: V'\times\mathbb{T}^{n} \longrightarrow V\times\mathbb{T}^n \\
        (\vb{I}', \boldsymbol{\phi}') \longrightarrow(\vb{I}, \boldsymbol{\phi})
        \end{array}
    \end{equation}
    with $V' \subseteq \mathbb{R}^n$ open;
    \item [(b).] a set $V_\epsilon \subseteq V'$;
    \item [(c).] a smooth function $h'_\epsilon(\vb{I}', \boldsymbol{\phi}')$ defined on $V'\times \mathbb{T}^n$;
\end{enumerate}
which satisfy
\begin{enumerate}
    \item [(i).] $\operatorname{Vol}(V\textbackslash V_\epsilon) \leq a_1\sqrt{\epsilon}$;
    \item [(ii).] $\norm{\vb{I}-\vb{I}'}\leq a_2 \sqrt{\epsilon}$, $\norm{\boldsymbol{\phi} - \boldsymbol{\phi}'} \leq a_3 \sqrt{\epsilon}$;
    \item [(iii).] whenever $\vb{I}'\in V_\epsilon$ the perturbed Hamiltonian field $\ham_\epsilon \circ \mathcal{C}_\epsilon (\vb{I}', \boldsymbol{\phi}')$ admits an invariant torus.
\end{enumerate}

\end{theorem}

From this theorem, we can define a set $\mathcal{S}_\epsilon = \mathcal{C}_\epsilon(V_\epsilon \times \mathbb{T}^n) \subseteq V \times \mathbb{T}^n$ of large measure composed of invariant tori. This set is also referred to as the set of \textit{KAM tori}. Within this set, due to \textit{(ii)}, we have that any orbit $(\vb{I}(t), \boldsymbol{\phi}(t))$ having initial condition $(\vb{I}(0), \boldsymbol{\phi}(0)) \in \mathcal{S}_\epsilon$ satisfies the relation $\forall\; t$
\begin{equation}
    \norm{\vb{I}(t) - \vb{I}(0)} \leq 2 a_2 \sqrt{\epsilon} \,.
\end{equation}
This set of invariant tori $\mathcal{S}_\epsilon$ is constructed as a complement of a neighbourhood of all the non-linear resonances regions in the phase space. Meaning, if we consider any vector $k\in \mathbb{Z}^n$ defining a resonance order, we have a resulting resonant manifold which reads
\begin{equation}
    \mathcal{R}_k = \left\{\vb{I}\in V \, \big| \, \sum_i k_i \omega_i(\vb{I}) = 0\right\} \,,
\end{equation}  
and we exclude a neighbourhood of $\mathcal{R}_k$ following a Diophantine law:
\begin{equation}
    \left|\sum_i k_i \omega_i(\vb{I})\right| \leq \frac{\gamma_0 \sqrt{\epsilon}}{|k|^\tau} \,,
    \label{eq:Diophantine-law}
\end{equation}
where $\gamma_0 > 0$ is a suitable positive constant and $\tau > n-1$. This excluded neighbourhood of resonances is referred to as \textit{Arnol'd web}.

The proof of the KAM theorem is based on the possibility to define a converging procedure for consistently eliminating the fast phases of $\ham$ in increasingly high orders in the small parameter. Such procedure has the property of quadratic convergence, as after $m$ successive changes of variables, the phase-dependent discrepancy in the new Hamiltonian is of order $\epsilon^{2^m}$.

At each step, the generating function is constructed on the sum of the Fourier harmonics of $\ham_1$ whose order do not exceed an integer $N$. The integer $N$ is then chosen so that the absolute value of the remainder $R_{1N} = \ham_1 - \ham_{1N}$ of the Fourier series does not exceed $\epsilon$. These progressive steps gradually lead to a superconvergence to the non-resonant KAM set.

The KAM theorem has important consequences for the analysis of stability of perturbed Hamiltonian systems. The most immediate one being the existence of large invariant compact regions for Hamiltonian systems, that implies the global stability of the orbits for systems with two degrees of freedom:
\begin{theorem}(\cite{KAM1})
    In an isoenergetically non-degenerate system with two degrees of freedom, all initial conditions will have their action variables remaining near their initial value.
\end{theorem} 
This theorem has immediate proof, as such a system has a four-dimensional phase space with three-dimensional energy levels which are highly populated by two-dimensional KAM tori. Since a two-dimensional torus has the topological property to divide a three-dimensional energy level, an orbit starting in a gap between two KAM tori will be forever trapped between those tori. Resulting action variable oscillations will not exceed the order of magnitude of $\sqrt{\epsilon}$, following the estimates given by KAM theorem. 

When instead we are considering a system with more than two degrees of freedom, we have that the $n-$dimensional invariant tori do not separate a $(2n-1)$-dimensional energy-level manifold like points on a plane or lines in a space. Consequently, the gaps between tori, related by different resonance spaces, are all connected with each other. Therefore, the KAM Theorem does not prevent an orbit with initial condition near a resonance region to eventually evolve far away from its initial action value. 

\section{Nekhoroshev theorem}\label{sec:1:nekhoroshev}
%  Qui come sopra: il th di Nekhoroshev ha molte formulazioni (soprattutto per la questione dell'esponente nella stima ottimale). Io non entrerei nei dettagli ma nella generalità del risultato correlato all'analiticità delle serie perturbative

As stated in the previous section, even though the stability set $\mathcal{S}_\epsilon$ has large relative measure, its complement can be open, dense, and if the number of degrees of freedom is larger than two, also connected, enabling the orbits' diffusion in the phase space.

Therefore, the possibility for solutions to wandering the complement of $\mathcal{S}_\epsilon$, such as the so called Arnol’d diffusion, can prevent any result of stability over an infinite time.

For this reason, it becomes difficult (if not impossible) to treat the problem of the orbit stability for infinite time in the case of a perturbed Hamiltonian system. But it is possible to operate with asymptotic estimates, which are limited to very long times\footnote{For example, in the case of hadron colliders orders of magnitudes higher than the usual operation time.}. We look for estimates in the following form:
\begin{equation}
    \norm{\vb{I}(t)-\vb{I}(0)} \leq r(\epsilon)
\end{equation}
which are valid for times $|t| \leq T(\epsilon)$ such that $r \rightarrow 0$ and $T \rightarrow \infty$ in the limit $\epsilon \rightarrow 0$. 

In the case $\ham$ satisfies a technical property called \textit{steepness}\footnote{The notion of steepness was introduced by Nekhoroshev in~\cite{N_N_Nehorošev_1973}. The definition we report here is a necessary and sufficient condition for steepness~\cite{AIF_2006__56_3_795_0}.}, a very important result on the estimate of diffusion scale times holds. An analytic function is said to be \textit{steep} if it has no stationary points and its restriction to any plane of any dimension has only isolated stationary points.

Such result is stated by Nekhoroshev in his celebrated theorem, named after him:
\begin{theorem}[Nekhoroshev's theorem~\cite{Nekhoroshev:1977aa}]
    Let us consider a perturbed Hamiltonian system in the form of Eq~\eqref{eq:1:hamperturbed}. If the unperturbed Hamiltonian $\ham_0$ is steep, there exist positive constants $\epsilon_0, a, b, t_0, r$ such that for any $\epsilon<\epsilon_0$, and for any motion $(\vb{I}(t), \boldsymbol{\phi}(t))$ with $(\vb{I}(0), \boldsymbol{\phi}(0)) \in V \times \mathbb{T}^n$ it is
    \begin{equation}
        \norm{\vb{I}(t)-\vb{I}(0)} \leq r \epsilon^a \,,
    \end{equation}
    for any time t satisfying:
    \begin{equation}
        0 \leq t \leq t_0 \exp \left(\frac{\epsilon_0}{\epsilon}\right)^b \,,  
    \end{equation}
    where the value of the constants $a, b$ depend on the steepness properties of $\ham_0$.
\end{theorem}

A complete overview of the theorem's proof is presented in~\cite{Guzzo2007}, the outline of it is that the long-term behaviour of the orbits can be studied removing from $\ham$ only a finite number of harmonics in an open subset of the phase space $\epsilon \ham_{1k}(\vb{I}) e^{i k \cdot \boldsymbol{\phi}}$, precisely those with order $|k|=\sum_{i=1}^n\left|k_i\right|$ up to a given threshold $K$. The harmonics with $|k| \geq K$ can then be estimated to be exponentially small. As a consequence, if $K$ is suitably large, these terms turn out to be very small, and they can determine large deviations of the actions only after long exponential times.

\section{Symplectic maps}

A $2n \times 2n$ matrix $\mathrm{A}$ is defined as \text{symplectic} if it satisfies the equation
\begin{equation}
    \mathrm{A} \mathrm{J} \mathrm{A}^t=\mathrm{J} \,,
\end{equation}
where $\mathrm{A}^t$ denotes the transposed matrix and $\mathrm{J}$ is a block matrix defined according to
\begin{equation}
    \mathrm{J}=\left(\begin{array}{cc}
        0 & \mathrm{I}_n \\
        -\mathrm{I}_n & 0 
    \end{array}\right) \,,
\end{equation}
where $\mathrm{I}_n$ is the $n\times n$ identity matrix.

A map $\mathrm{M}: \mathbb{R}^{2n} \rightarrow \mathbb{R}^{2n}$ is said to be a \textit{symplectic map} if its Jacobian matrix $\mathrm{DM}$, whose elements $\mathrm{DM}_{i, j}$ are given by
\begin{equation}
    \mathrm{DM}_{i, j}(\vb{x}) \equiv \frac{\partial \mathrm{M}_i}{\partial x_j}(\vb{x}) \,,
\end{equation}
is a symplectic matrix for every $\vb{x}$, meaning
\begin{equation}
    \mathrm{DM}(\vb{x}) \mathrm{J} \mathrm{DM}^t(\vb{x})=\mathrm{J} .
\end{equation}
The symplectic condition for a map characterizes the canonical transformations of the phase space and the phase flows of Hamiltonian systems. In the case of a 2-dimensional map it reduces to the area-preserving condition.

An example of symplectic map is defined by the Poincaré map of a Hamiltonian phase flow on a section of the phase space or by the one period evolution map in case of periodic Hamiltonian systems.  A simple conceptual scheme of a Poincaré section is shown in Fig.~\ref{fig:poincare}. For a time-dependent Hamiltonian $\ham(\vb{x}, t)$, with period $T$ ($\ham(\vb{x}, t=T) = \ham(\vb{x}, t=0)$), one can define a symplectic map $\mathrm{M}$ as the one period map which will represent the evolution of an initial condition $\vb{x}(0)$ to $\vb{x}(T)$. 

\begin{figure}
	\centering
	\def\svgwidth{0.5\columnwidth}
    \import{2_accelerator_physics_fundamentals/figs}{poincare.pdf_tex}
    \caption{Simple sketch of the concept behind a Poincaré section of a symplectic evolution.}
    \label{fig:poincare}
\end{figure}

\subsection{Poincaré-Birkhoff theorem}\label{subsec:poincare-birkhoff}

After we have seen the most important theorems on how small perturbations can affect the dynamics of a Hamiltonian system, we are interested to discuss some specific results for the dynamics described by an area-preserving map.

The first important theorem we will present is the Poincaré-Birkhoff theorem~\cite{birkhoff}. This theorem shows how the interplay between the perturbation and the natural resonances present in the map leads to the creation of new structures in the phase space, also referred to as \textit{resonant islands}.

Let us consider an area-preserving map $\mathrm{T}_k$ ($k\in\mathbb{Z}$). If the system described by $\mathrm{T}_k$ is integrable, we can define action-angle coordinates $(\boldsymbol{\phi},\,\vb{I})$ where, for every $I$, an invariant curve $\Gamma_{I}$ is defined, along which, at each turn, $\phi$ increases by an angle $\omega(I)$. The map $\mathrm{T}_j$ therefore will read as a \textit{twist map}:
%
\begingroup
\renewcommand*{\arraystretch}{1.5}
\begin{equation}
	\begin{pmatrix} {\phi}^{(k+1)} \\ {I}^{(k+1)} \end{pmatrix}  = \begin{pmatrix} {\phi}^{(k)} + {\omega}_j\left({I}^{(k)}\right) \\ {I}^{(k)} \end{pmatrix} \, .
\end{equation}
\endgroup

Since the frequency  is a generic function of the action $I$, we have that some initial conditions $\mathbf{x}(\phi,I)$ will have a resonant frequency ${\omega}({I})/(2\pi)\in \mathbb{Q}$, i.e.\ a frequency $n\omega(I)=2\pi \ell$. For these resonant frequencies, we have that the $n-$th iteration of the map $\mathrm{T}^n$ will map a point into itself, and that the resulting orbit given by $\mathrm{T}^k \mathbf{x}_0$ will be a finite set of $n$ points. For non-resonant frequencies, i.e.\ $\omega(I)/(2\pi) \in \mathbb{R}\setminus \mathbb{Q}$, the orbit given by $\mathrm{T}^k \mathbf{x}_0$ is dense on the invariant curve $\Gamma_{I}$.

Now let us introduce a perturbation of the map $\mathrm{T}_{k,\epsilon} = \mathrm{T}_k + \epsilon \mathrm{T}^{(1)}_k$, the resulting perturbed map $\mathrm{T}_{j,\epsilon}$ will now read
\begingroup
\renewcommand*{\arraystretch}{1.5}
\begin{equation}
	\begin{pmatrix} \phi^{(k+1)} \\ I^{(k+1)} \end{pmatrix}  = \begin{pmatrix} \phi^{(k)} + \omega_j\left(I^{(k)}\right) + \epsilon f(I^{(k)}, \phi^{(k)}) \\ I^{(k)}  + \epsilon g(I^{(k)}, \phi^{(k)}) \end{pmatrix} \, ,
    \label{eq:area_perturbed_map}
\end{equation}
\endgroup
with $f, g$ regular on their domains. The Poincaré-Birkhoff theorem states that if and $d\omega/dI\ne 0$, the unperturbed resonant invariant curves $\Gamma_I$, with $n\omega(I)=2\pi \ell$, will be not preserved by the perturbation. However, the perturbed map $\mathrm{T}^n_{\epsilon}$ will have a chain of $2n$ fixed points close to $\Gamma_I$, half of them are elliptic, and half of them hyperbolic. Near the elliptic fixed point there exist new invariant curves that corresponds to the KAM tori with non-resonant secondary frequencies, whereas the separatrix curves connecting the hyperbolic points creates a chaotic layer.

The sketch of the proof is based on the fact that the derivative of the function $\omega(I)$ is not vanishing.  If the invariant curve $\Gamma_{I}$, have a resonant frequency $\omega$- of order $n$, each point of the curve is a fixed point for the map $\mathrm{T}^n$. This implies that there exist also the curves $\Gamma_+$, where $I_+>I^*$, and $\Gamma_-$, where $I_-<I^*$, on which $\phi$ rotates with opposite direction. We can assume, without loss of generality, that $n\omega(I_-)<n\omega(I^*)<n\omega(I_+)$ and, therefore, $\omega(I_-)<0$ and $\omega(I_+)>0$.

This fact holds also for the perturbed map $\mathrm{T}_\epsilon$. Due to the regularity of $f$ and $g$, we know that for each angle $\phi$ there exists a value of the action $I_\phi$, for which $\mathrm{T}^n_\epsilon$ has zero phase advance. The set of all pairs $(\phi, I_\phi)$ describes a closed curve that we name $R_\epsilon$, which will describe a full radial variation under the action of $\mathrm{T}^n_\epsilon$. This curve $R_\epsilon$ will be close to the unperturbed invariant curve $\Gamma_I$. Let us now define as $R_\epsilon'$ the resulting curve having applied $\mathrm{T}^n_\epsilon$ at each point of $R_\epsilon$, as stated before, the difference will be a variation in radius. As the map is area-preserving, the area enclosed by the evolved curve $R_\epsilon'$ cannot be greater or smaller than the area enclosed by the starting curve $R_\epsilon$. Therefore, it is impossible that one of the two curves surrounds the other, and they must intersect in an even number of points, and the points of intersection are fixed points of $\mathrm{T}^n_\epsilon$. A schematic picture of this scenario is given in Fig.~\ref{fig:tnepsilon}.

To determine the nature of these fixed points, that is, to assess whether they are stable elliptic points or unstable hyperbolic points, we have to consider the flow of $\mathrm{T}^n$ in the neighbourhood of $\Gamma^+$ and $\Gamma^-$ and look at how it connects to the dynamics of the orbits given by $R_\epsilon \to T^n R_\epsilon$.

If we inspect the arrows represented in Fig.~\ref{fig:tnepsilon}, we can distinguish two different scenarios at the intersections. When the arrows move around the fixed point, it is an elliptic fixed point. When the arrows move \textit{away} from the fixed point, the dynamic is hyperbolic. It follows that these $2n$ fixed points will be an alternation of $n$ elliptic fixed points of period $n$, with $n$ hyperbolic fixed points of the same period. This pattern of fixed points gives the origin to the Poincaré-Birkhoff islands.

\begin{figure}
	\centering
	\def\svgwidth{0.75\columnwidth}
    \import{1_mathematical_elements/figs}{poincare.pdf_tex}
    \caption{Schematic picture of the concept behind the Poincaré-Birkhoff theorem proof. The invariant curves $\Gamma_-$ and $\Gamma_+$ are characterized by rotation frequencies different in sign under the perturbed map $\mathrm{T}^n_(\epsilon)$. The curve $R_\epsilon$ is made of points with no rotation, and it is mapped into $R_\epsilon'$ by the map. As the map is area-preserving, we observe an even number of intersections between $R_\epsilon$ and $R_\epsilon'$, which correspond to the fixed points given by the theorem. These fixed points can be distinguished between elliptic and hyperbolic by inspecting the direction of the arrows in the pictures, which ultimately represents the dynamic flow near them. Elliptic points (blue stars) have arrows rotating around them, hyperbolic points (red stars) have arrows pointing away from them.}
    \label{fig:tnepsilon}
\end{figure}

\subsection{KAM and Nekhoroshev theorems for symplectic maps}

The Poincaré-Birkhoff theorem suggests that the effect of a small perturbation on an integrable symplectic map preserve the non-resonant invariant curves according to the KAM theorem. A more precise statement  is obtained by extending the KAM theorem to symplectic maps.

Likewise, also the results presented in the Nekhoroshev theorem can be extended to symplectic maps. However, for both theorems, the final statements are not necessary identical to the Hamiltonian version (see \cite{Bazzani:262179} and references therein).

\begin{theorem}[KAM, area-preserving maps]
    Let us consider a perturbed symplectic map like the one in Eq.~\eqref{eq:area_perturbed_map}, where $f$ and $g$ are analytic on their domains, and let $\boldsymbol{\omega}$ be a frequency vector that follows a Diophantine law like the one presented in Eq.~\eqref{eq:Diophantine-law}. Then, an invariant orbit with frequency vector $\boldsymbol{\omega}$ in the unperturbed system is mapped into a closed orbit of the perturbed system for $\epsilon$ sufficiently small. Moreover, the measure of the closed orbits in a polydisc $\norm{\vb{I}} \ll R$ approaches the measure of the disc itself as $\epsilon \to 0$. 
\end{theorem}

The theorem is very similar to Theorem~\ref{th:kam}: for symplectic maps we have that the KAM theorem guarantees stability of motion only for maps up to 2\textsc{d}, where a 1\textsc{d} invariant curve constitutes a topological barrier to the motion. For higher dimensions, the existence of invariant tori does not constitute such a barrier. For example, in a 4\textsc{d} map, a KAM tori will be a 2\textsc{d} tori (i.e.\ the direct product of two circles), which does not constitute a topological barrier as its complement is a connected set of dimension two.

A more broad stability result is obtained by generalizing the Nekhoroshev theorem for Hamiltonian flows to symplectic maps~\cite{Bazzani:1990aa, Turchetti:1990aa}.

\begin{theorem}[Nekhoroshev, symplectic maps]
    Let us consider a symplectic map in a phase space of dimension 2$n$, with $n\geq 2$, analytic in a polydisc of unit radius, having the origin as an elliptic fixed point. If the frequency vector $\omega$ satisfies the Diophantine condition, then any orbit with initial point in a polydisc of radius $I/2$ will remain in a polydisc of radius $I$ for a time $t\leq T$, with
    \begin{equation}
    \label{nekest}
        T = T_0 \exp\left[\left(\frac{I_\ast}{I}\right)^{1/2\kappa}\right]\,,
    \end{equation}
    with the constants $\kappa$, $T_0$, and $I_\ast$ depending on the Diophantine condition and the Fourier components of the perturbation.
\end{theorem}
The estimate (\ref{nekest}) can be also related to the optimal estimate in the order of the asymptotic perturbative expansion that reduces the perturbed map to an integrable form.